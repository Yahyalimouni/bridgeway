<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BRIDGEWAY</title>

  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              blueDark: '#0a0f4c',   /* azul más oscuro (del logo) */
              blue:     '#4967e4',   /* azul más claro (del logo)  */
              accent:   '#eaf0ff'
            }
          },
          boxShadow: {
            soft: '0 12px 40px rgba(10,15,76,.10)'
          }
        }
      }
    }
  </script>
  <style>
    .surface { background: linear-gradient(180deg, #ffffff, #f9fbff); }
    .glass { background: rgba(255,255,255,.75); backdrop-filter: blur(10px); }
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 3px rgba(73,103,228,.45); }
    .hero-bg {
      background:
        radial-gradient(36rem 20rem at 110% -10%, rgba(73,103,228,.18), transparent 60%),
        radial-gradient(28rem 16rem at -10% -10%, rgba(10,15,76,.12), transparent 60%),
        linear-gradient(180deg, #ffffff, #f6f9ff);
    }
    .fade-in { animation: fade .5s ease both; }
    @keyframes fade { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform: none} }
  </style>
</head>
<body class="min-h-screen surface text-brand-blueDark selection:bg-brand-blue selection:text-white">
  <!-- HEADER -->
  <header id="appHeader" class="sticky top-0 z-40 border-b border-brand-accent/70 bg-white/85 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <!-- Wordmark tipográfico -->
      <div class="select-none tracking-wide font-extrabold text-xl md:text-2xl leading-none">
        <span style="color:#0a0f4c">BRIDGE</span><span style="color:#4967e4">WAY</span>
      </div>
      <!-- Control superior -->
      <div class="flex items-center gap-3">
        <label for="lang" class="text-sm" data-i18n="langLabel">Limba</label>
        <select id="lang" class="h-9 rounded-xl border border-brand-accent bg-white px-2 focus-ring">
          <option value="ro">RO</option>
          <option value="ru">RU</option>
          <option value="en">EN</option>
        </select>
        <label class="inline-flex items-center gap-2 text-sm pl-2 border-l border-brand-accent">
          <input id="focusMode" type="checkbox" class="h-4 w-4">
          <span data-i18n="focus">Mod focalizare</span>
        </label>
      </div>
    </div>
    <!-- NAV -->
    <div class="max-w-7xl mx-auto px-4 pb-3">
      <nav class="flex items-center gap-1 text-sm">
        <button data-nav="home" class="nav-pill px-3 py-1.5 rounded-full border border-brand-accent hover:bg-brand-accent/60">Acasă</button>
        <button data-nav="practice" class="nav-pill px-3 py-1.5 rounded-full border border-brand-accent hover:bg-brand-accent/60">Practică</button>
        <button data-nav="history" class="nav-pill px-3 py-1.5 rounded-full border border-brand-accent hover:bg-brand-accent/60">Istoric</button>
        <button data-nav="help" class="nav-pill px-3 py-1.5 rounded-full border border-brand-accent hover:bg-brand-accent/60">Ajutor</button>
      </nav>
    </div>
  </header>

  <!-- HERO -->
  <section id="home" class="hero-bg">
    <div class="max-w-7xl mx-auto px-4 py-12 md:py-16 grid md:grid-cols-2 gap-10 items-center">
      <div class="fade-in">
        <h1 class="text-4xl md:text-5xl font-extrabold leading-tight" data-i18n="hero.title">
          Podul tău către o engleză sigură
        </h1>
        <p class="mt-4 text-lg text-brand-blueDark/90" data-i18n="hero.subtitle">
          Exersezi situații reale, primești corectare clară și îți urmărești progresul în timp real. Învățare practică, eficientă și modernă.
        </p>
        <div class="mt-6 p-5 rounded-2xl border border-brand-accent glass shadow-soft">
          <p class="font-medium text-brand-blue" data-i18n="hero.ctaTitle">Învățare consecventă</p>
          <p class="mt-1 text-sm" data-i18n="hero.ctaText">Pași mici, progres constant. Practică zilnic și treci la nivelul următor.</p>
        </div>
        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#practice" data-nav="practice"
             class="start-btn inline-flex items-center px-5 py-3 rounded-2xl bg-brand-blue text-white shadow-soft hover:opacity-95 focus-ring"
             data-i18n="hero.start">Începe practica</a>
          <a href="#history" data-nav="history"
             class="inline-flex items-center px-5 py-3 rounded-2xl border border-brand-accent bg-white hover:bg-brand-accent/60 focus-ring"
             data-i18n="hero.history">Vezi istoricul</a>
        </div>
      </div>
      <div class="fade-in">
        <!-- Panel destilado con bullets minimalistas -->
        <div class="rounded-2xl border border-brand-accent glass shadow-soft p-6">
          <div class="grid gap-5">
            <div>
              <div class="font-semibold" data-i18n="feature.immediate">Corectare imediată</div>
              <p class="text-sm text-brand-blueDark/80" data-i18n="feature.immediateDesc">
                Explicații clare: de ce este greșit și cum este corect, cu formulări naturale.
              </p>
            </div>
            <div>
              <div class="font-semibold" data-i18n="feature.results">Rezultate transparente</div>
              <p class="text-sm text-brand-blueDark/80" data-i18n="feature.resultsDesc">
                Notă, detalii pe întrebare, recomandări și istoric.
              </p>
            </div>
            <div>
              <div class="font-semibold" data-i18n="feature.context">Context realist</div>
              <p class="text-sm text-brand-blueDark/80" data-i18n="feature.contextDesc">
                Restaurant, călătorii, muncă, examene — ceea ce folosești în viața reală.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PRACTICE (moderno: 1 pregunta por pantalla + stepper + anillo de progreso) -->
  <section id="practice" class="max-w-7xl mx-auto px-4 py-10 hidden">
    <div class="rounded-2xl border border-brand-accent glass shadow-soft p-6">
      <!-- Top controls -->
      <div class="flex flex-col md:flex-row md:items-end gap-3">
        <div class="grow">
          <label class="text-sm font-medium" data-i18n="practice.nameLabel">Numele elevului/elevei</label>
          <input id="studentName" type="text" placeholder="Introdu numele"
                 class="mt-1 w-full px-4 h-11 rounded-2xl border border-brand-accent focus-ring"/>
        </div>
        <button id="startBtn"
                class="h-11 px-5 rounded-2xl bg-brand-blue text-white shadow-soft disabled:opacity-40 focus-ring"
                data-i18n="practice.start">Pornește</button>
      </div>

      <!-- Progress header -->
      <div class="mt-6 grid md:grid-cols-[1fr_auto] gap-4 items-center">
        <!-- Stepper -->
        <div id="stepper" class="flex flex-wrap gap-2"></div>
        <!-- Progress ring -->
        <div class="flex items-center gap-3">
          <svg id="ring" width="52" height="52" viewBox="0 0 36 36" class="rotate-[-90deg]">
            <circle cx="18" cy="18" r="16" fill="none" stroke="#e5edff" stroke-width="3"></circle>
            <circle id="ringBar" cx="18" cy="18" r="16" fill="none" stroke="#4967e4" stroke-width="3" stroke-linecap="round" stroke-dasharray="100 100" stroke-dashoffset="100"></circle>
          </svg>
          <div>
            <div class="text-xs" data-i18n="practice.progress">Progres</div>
            <div id="progressText" class="text-sm font-semibold text-brand-blue">0%</div>
          </div>
        </div>
      </div>

      <!-- Question viewport -->
      <div id="qViewport" class="mt-6"></div>

      <!-- Bottom bar -->
      <div class="mt-6 flex flex-wrap items-center gap-3">
        <button id="prevBtn" class="h-11 px-5 rounded-2xl border border-brand-accent bg-white focus-ring">◀</button>
        <button id="nextBtn" class="h-11 px-5 rounded-2xl border border-brand-accent bg-white focus-ring">▶</button>
        <div class="ml-auto text-sm font-semibold text-brand-blue" id="liveScore"></div>
        <button id="submitBtn" class="h-11 px-6 rounded-2xl bg-brand-blue text-white shadow-soft disabled:opacity-40 focus-ring" data-i18n="practice.submit">
          Predă
        </button>
      </div>
      <div class="text-xs text-brand-blueDark/70 mt-1" data-i18n="hotkeys">Atajos: Enter = verifică/următorul, ← → = navigare</div>
    </div>

    <!-- Results -->
    <div id="results" class="mt-6 hidden rounded-2xl border border-brand-accent glass shadow-soft p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold" data-i18n="results.title">Rezultate</h2>
        <div id="scoreBadge" class="text-sm font-semibold px-3 py-1 rounded-full border border-brand-accent"></div>
      </div>
      <div id="breakdown" class="grid md:grid-cols-3 gap-4 mt-4"></div>
      <div class="mt-5 flex gap-3">
        <button data-nav="practice" class="h-11 px-6 rounded-2xl bg-brand-blue text-white shadow-soft focus-ring" data-i18n="results.again">Reia practica</button>
        <button data-nav="history" class="h-11 px-6 rounded-2xl border border-brand-accent bg-white focus-ring" data-i18n="results.viewHistory">Vezi istoricul</button>
      </div>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="history" class="max-w-7xl mx-auto px-4 py-10 hidden">
    <div class="rounded-2xl border border-brand-accent glass shadow-soft p-6">
      <h2 class="text-xl font-bold mb-4" data-i18n="history.title">Istoric de încercări</h2>
      <div id="historyList" class="grid gap-3"></div>
      <p id="emptyHistory" class="text-sm text-brand-blueDark/70" data-i18n="history.empty">Încă nu ai încercări. Completează o practică pentru a vedea progresul aici.</p>
    </div>
  </section>

  <!-- HELP -->
  <section id="help" class="max-w-7xl mx-auto px-4 py-10 hidden">
    <div class="rounded-2xl border border-brand-accent glass shadow-soft p-6">
      <h2 class="text-xl font-bold mb-3" data-i18n="help.title">Cum funcționează</h2>
      <ol class="list-decimal pl-5 space-y-2 text-brand-blueDark/90">
        <li data-i18n="help.step1">Introdu numele și apasă <b>Pornește</b>.</li>
        <li data-i18n="help.step2">Răspunde la fiecare întrebare (alegere multiplă sau răspuns scurt).</li>
        <li data-i18n="help.step3">Folosește <b>Verifică</b> la răspunsurile scurte pentru feedback imediat.</li>
        <li data-i18n="help.step4">Apasă <b>Predă</b> pentru nota finală și explicații complete.</li>
      </ol>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="mt-16 border-t border-brand-accent/70">
    <div class="max-w-7xl mx-auto px-4 py-8 text-sm text-brand-blueDark/70 flex items-center justify-between">
      <div>© <span id="year"></span> BRIDGEWAY</div>
      <div class="flex gap-4">
        <a class="hover:underline" href="#" data-i18n="footer.privacy">Confidențialitate</a>
        <a class="hover:underline" href="#" data-i18n="footer.contact">Contact</a>
      </div>
    </div>
  </footer>

  <!-- JS -->
  <script>
    /* ===== UTIL ===== */
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const fmtNow = (locale)=> new Date().toLocaleString(locale);

    /* ===== I18N ===== */
    const I18N = {
      ro: {
        langLabel:"Limba",
        focus:"Mod focalizare",
        nav:{home:"Acasă",practice:"Practică",history:"Istoric",help:"Ajutor"},
        hero:{
          title:"Podul tău către o engleză sigură",
          subtitle:"Exersezi situații reale, primești corectare clară și îți urmărești progresul în timp real. Învățare practică, eficientă și modernă.",
          ctaTitle:"Învățare consecventă",
          ctaText:"Pași mici, progres constant. Practică zilnic și treci la nivelul următor.",
          start:"Începe practica",
          history:"Vezi istoricul"
        },
        feature:{
          immediate:"Corectare imediată",
          immediateDesc:"Explicații clare: de ce este greșit și cum este corect, cu formulări naturale.",
          results:"Rezultate transparente",
          resultsDesc:"Notă, detalii pe întrebare, recomandări și istoric.",
          context:"Context realist",
          contextDesc:"Restaurant, călătorii, muncă, examene — ceea ce folosești în viața reală."
        },
        practice:{
          nameLabel:"Numele elevului/elevei",
          start:"Pornește",
          progress:"Progres",
          submit:"Predă",
          reset:"Resetează",
          placeholder:"Scrie răspunsul în engleză…",
          verify:"Verifică",
          completed:"Întrebări completate"
        },
        hotkeys:"Atajos: Enter = verifică/următorul, ← → = navigare",
        results:{title:"Rezultate",again:"Reia practica",viewHistory:"Vezi istoricul"},
        history:{title:"Istoric de încercări",empty:"Încă nu ai încercări. Completează o practică pentru a vedea progresul aici.",attempt:"Încercarea",date:"Data"},
        help:{title:"Cum funcționează",step1:"Introdu numele și apasă <b>Pornește</b>.",step2:"Răspunde la fiecare întrebare (alegere multiplă sau răspuns scurt).",step3:"Folosește <b>Verifică</b> la răspunsurile scurte pentru feedback imediat.",step4:"Apasă <b>Predă</b> pentru nota finală și explicații complete."},
        footer:{privacy:"Confidențialitate",contact:"Contact"},
        quiz:{
          qLabel:"Întrebarea",
          tip:"Sugestie",
          badge:{neutral:"De verificat",ok:"Corect",bad:"De revizuit"},
          choice:{
            2:["„Booking/Reservation” sunt corecte; adăugarea numelui este naturală.","Substantivul corect este „reservation”, nu „reserve”.","Formulare incorectă; spune „We have a reservation.”"],
            3:["Răspuns politicos dacă ai nevoie de timp.","Lipsește „for”; mai bine „Just a minute, please.”","Expresie nenaturală."],
            6:["Politicos: „I'd like…” + „please”.","Sună abrupt; preferă „I'd like…”.","Traducere literală greșită."],
            8:["Formulare naturală în fast food.","Imperativ; lipsește politețea.","Vocabular nenatural; se spune „fries”."]
          },
          shortOk:"Răspuns natural și politicos.",
          shortBad:"Formulare nenaturală sau incompletă.",
          recommend:"Recomandare",
          noOption:"Nu ai selectat nicio opțiune.",
          verifyBtn:"Verifică",
          showModel:"Arată modelul"
        }
      },
      ru: {
        langLabel:"Язык",
        focus:"Режим фокуса",
        nav:{home:"Главная",practice:"Практика",history:"История",help:"Помощь"},
        hero:{title:"Ваш мост к уверенному английскому",subtitle:"Практикуйтесь в реальных ситуациях, получайте понятные исправления и отслеживайте прогресс в реальном времени. Современно, практично и эффективно.",ctaTitle:"Последовательное обучение",ctaText:"Малые шаги — устойчивый прогресс. Занимайтесь ежедневно.",start:"Начать практику",history:"Открыть историю"},
        feature:{immediate:"Мгновенная проверка",immediateDesc:"Почему неверно и как правильно — с естественными формулировками.",results:"Прозрачные результаты",resultsDesc:"Оценка, разбор по вопросам, рекомендации и история.",context:"Реальный контекст",contextDesc:"Ресторан, путешествия, работа, экзамены."},
        practice:{nameLabel:"Имя ученика",start:"Начать",progress:"Прогресс",submit:"Сдать",reset:"Сбросить",placeholder:"Напишите ответ на английском…",verify:"Проверить",completed:"Отвечено"},
        hotkeys:"Горячие клавиши: Enter = проверить/далее, ← → = навигация",
        results:{title:"Результаты",again:"Повторить",viewHistory:"История"},
        history:{title:"История попыток",empty:"Пока нет попыток. Пройдите практику, чтобы увидеть прогресс.",attempt:"Попытка",date:"Дата"},
        help:{title:"Как это работает",step1:"Введите имя и нажмите <b>Начать</b>.",step2:"Отвечайте на вопросы (выбор или короткий ответ).",step3:"Нажимайте <b>Проверить</b> для мгновенной обратной связи.",step4:"Нажмите <b>Сдать</b> для итоговой оценки и объяснений."},
        footer:{privacy:"Конфиденциальность",contact:"Контакты"},
        quiz:{
          qLabel:"Вопрос",tip:"Подсказка",
          badge:{neutral:"Проверить",ok:"Верно",bad:"Проверить снова"},
          choice:{
            2:["Подходят «booking/reservation»; добавить имя — естественно.","Правильно «reservation», не «reserve».","Неверная конструкция; говорите «We have a reservation.»"],
            3:["Вежливо, если нужно время.","Нет «for»; лучше «Just a minute, please.»","Неестественная формулировка."],
            6:["Вежливо: «I'd like…» + «please».","Резко; лучше «I'd like…».","Буквальный перевод с ошибкой."],
            8:["Естественно для fast food.","Повелительный тон; нет вежливости.","Неестественная лексика; правильно «fries»."]
          },
          shortOk:"Естественный и вежливый ответ.",
          shortBad:"Неестественная или неполная формулировка.",
          recommend:"Рекомендация",
          noOption:"Вы не выбрали вариант.",
          verifyBtn:"Проверить",
          showModel:"Показать пример"
        }
      },
      en: {
        langLabel:"Language",
        focus:"Focus mode",
        nav:{home:"Home",practice:"Practice",history:"History",help:"Help"},
        hero:{title:"Your bridge to confident English",subtitle:"Practice real-life situations, get clear corrections, and track your progress in real time. Practical, effective, and modern.",ctaTitle:"Consistent learning",ctaText:"Small steps, steady progress. Practice daily.",start:"Start practice",history:"View history"},
        feature:{immediate:"Immediate correction",immediateDesc:"Clear: why it’s wrong and how to say it correctly, with natural phrasing.",results:"Transparent results",resultsDesc:"Score, per-question breakdown, recommendations, and history.",context:"Real context",contextDesc:"Restaurant, travel, work, exams."},
        practice:{nameLabel:"Student name",start:"Start",progress:"Progress",submit:"Submit",reset:"Reset",placeholder:"Type your answer in English…",verify:"Check",completed:"Answered"},
        hotkeys:"Shortcuts: Enter = check/next, ← → = navigate",
        results:{title:"Results",again:"Practice again",viewHistory:"View history"},
        history:{title:"Attempt history",empty:"No attempts yet. Complete a practice to see your progress here.",attempt:"Attempt",date:"Date"},
        help:{title:"How it works",step1:"Enter your name and press <b>Start</b>.",step2:"Answer each question (multiple choice or short answer).",step3:"Use <b>Check</b> on short answers for instant feedback.",step4:"Press <b>Submit</b> for the final score and explanations."},
        footer:{privacy:"Privacy",contact:"Contact"},
        quiz:{
          qLabel:"Question",tip:"Tip",
          badge:{neutral:"To check",ok:"Correct",bad:"Review"},
          choice:{
            2:["“Booking/Reservation” are both fine; adding a name is natural.","Use the noun “reservation,” not “reserve.”","Incorrect structure; say “We have a reservation.”"],
            3:["Polite if you need more time.","Missing “for”; better “Just a minute, please.”","Unnatural expression."],
            6:["Polite: “I'd like…” + “please.”","Sounds abrupt; prefer “I'd like…”.","Literal translation with wrong wording."],
            8:["Natural in fast food contexts.","Imperative tone; lacks politeness.","Unnatural vocabulary; say “fries.”"]
          },
          shortOk:"Natural and polite answer.",
          shortBad:"Unnatural or incomplete phrasing.",
          recommend:"Recommendation",
          noOption:"You didn’t select an option.",
          verifyBtn:"Check",
          showModel:"Show model"
        }
      }
    };

    /* ===== QUIZ BANK (EN prompts; localized guidance) ===== */
    const QUIZ = [
      { id:1, prompt:"A table for how many?", type:"short",
        expected:["A table for two, please.","For two, please.","A table for four, please.","For four, please."],
        guidance:{ro:"Număr + politețe. Exemplu: „A table for two, please.”", ru:"Число людей + вежливость. Пример: “A table for two, please.”", en:"Number of people + politeness. E.g., “A table for two, please.”"}
      },
      { id:2, prompt:"Do you have a reservation?", type:"choice",
        options:[ {text:"Yes, we have a booking under Smith.",correct:true},{text:"Yes, I have a reserve.",correct:false},{text:"Yes, we are booked person.",correct:false} ],
        guidance:{ro:"Natural: „Yes, we have a reservation under [name].”", ru:"Естественно: “Yes, we have a reservation under [name].”", en:"Natural: “Yes, we have a reservation under [name].”"}
      },
      { id:3, prompt:"Are you ready to order?", type:"choice",
        options:[ {text:"Just a minute, please.",correct:true},{text:"Wait me, please.",correct:false},{text:"Give me one time.",correct:false} ],
        guidance:{ro:"Dacă ești gata: „Yes, I am. I'd like the …”", ru:"Если готовы: “Yes, I am. I'd like the …”", en:"If ready: “Yes, I am. I'd like the …”"}
      },
      { id:4, prompt:"Would you like an appetizer?", type:"short",
        expected:["Yes, I'd like the soup, please.","No, thank you."],
        guidance:{ro:"Pentru a comanda: „I'd like…”. Pentru a refuza: „No, thank you.”", ru:"Заказ: “I'd like…”. Отказ: “No, thank you.”", en:"To order: “I'd like…”. To decline: “No, thank you.”"}
      },
      { id:5, prompt:"Would you like anything to drink?", type:"short",
        expected:["Yes, a Coke, please.","Yes, some water, please.","No, thank you."],
        guidance:{ro:"Numărabile: „a Coke”; nenumărabile: „some water”.", ru:"Исчисляемые: “a Coke”; неисчисляемые: “some water”.", en:"Countables: “a Coke”; uncountables: “some water.”"}
      },
      { id:6, prompt:"Would you like dessert?", type:"choice",
        options:[ {text:"Yes, I’d like chocolate cake, please.",correct:true},{text:"Yes, I want chocolate cake.",correct:false},{text:"I desire cake of chocolate.",correct:false} ],
        guidance:{ro:"„I'd like…” este mai politicos decât „I want…”", ru:"«I'd like…» вежливее, чем «I want…»", en:"“I'd like…” is more polite than “I want…”"}
      },
      { id:7, prompt:"Would you like another coffee?", type:"short",
        expected:["Yes, please.","No, thank you."],
        guidance:{ro:"La oferte repetate: „Yes, please.” / „No, thank you.”", ru:"На повторное предложение: “Yes, please.” / “No, thank you.”", en:"For repeated offers: “Yes, please.” / “No, thank you.”"}
      },
      { id:8, prompt:"Would you like fries with that?", type:"choice",
        options:[ {text:"Yes, please. Make it a combo.",correct:true},{text:"Yes, give me fries with this.",correct:false},{text:"I want potatoes sticks.",correct:false} ],
        guidance:{ro:"Poți specifica mărimea: small/large portion.", ru:"Можно указать размер: small/large portion.", en:"You can specify size: small/large portion."}
      },
      { id:9, prompt:"How is everything?", type:"short",
        expected:["Everything's great, thank you.","It’s a bit salty.","Could we get some more water, please?"],
        guidance:{ro:"Răspuns pozitiv, comentariu specific sau cerere politicoasă.", ru:"Положительный ответ, конкретный комментарий или вежливая просьба.", en:"Positive answer, specific comment, or polite request."}
      },
      { id:10, prompt:"Would you like anything else?", type:"short",
        expected:["No, that’s all, thank you.","Yes, could we have the bill, please?"],
        guidance:{ro:"Închiderea comenzii: „Could we have the bill, please?”", ru:"Завершение заказа: “Could we have the bill, please?”", en:"Closing the order: “Could we have the bill, please?”"}
      }
    ];

    /* ===== STATE ===== */
    let lang = 'ro';
    let started = false;
    let order = [];
    let idx = 0;
    let answers = {};
    const LS_KEY = 'bridgeway_history_modern';

    /* ===== NAV & INIT ===== */
    function setView(view){
      ["home","practice","history","help"].forEach(v => {
        const sec = document.getElementById(v);
        if (sec) sec.classList.toggle("hidden", v !== view);
      });
      $$(".nav-pill,[data-nav]").forEach(b=>{
        const tgt = b.getAttribute("data-nav"); if(!tgt) return;
        const active = tgt === view;
        b.classList.toggle("bg-brand-blue", active);
        b.classList.toggle("text-white", active);
      });
      if (view === "history") renderHistory();
    }
    function initNav(){
      $$(".nav-pill,[data-nav]").forEach(b=>{
        b.addEventListener("click", e=>{
          e.preventDefault();
          const tgt = b.getAttribute("data-nav"); if (tgt) setView(tgt);
        });
      });
    }

    /* ===== I18N APPLY ===== */
    function t(path){ return path.split('.').reduce((o,k)=>o&&o[k], I18N[lang]); }
    function applyI18N(){
      document.documentElement.lang = lang;
      $$("[data-i18n]").forEach(el=>{
        const key = el.getAttribute("data-i18n");
        const val = t(key);
        if (!val) return;
        if (/<.*>/.test(val)) el.innerHTML = val; else el.textContent = val;
      });
      $("#studentName")?.setAttribute("placeholder", t("practice.placeholder"));
      // nav
      const navKeys = ["home","practice","history","help"];
      navKeys.forEach(k => $$(`[data-nav="${k}"]`).forEach(el => el.textContent = t(`nav.${k}`)));
      // rerender question if active
      if (started) renderQuestion();
      renderHistory();
    }

    /* ===== QUIZ FLOW ===== */
    function shuffle(a){ return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]); }
    function normalize(s){ return (s||"").toLowerCase().replace(/[^a-z\\d\\s'.,-]/g,"").replace(/\\s+/g," ").trim(); }

    function startQuiz(){
      order = shuffle(QUIZ.map(q => JSON.parse(JSON.stringify(q))));
      answers = {};
      idx = 0;
      buildStepper();
      renderQuestion();
      updateMetrics();
      $("#results").classList.add("hidden");
      $("#liveScore").textContent = "";
    }

    function buildStepper(){
      const s = $("#stepper");
      s.innerHTML = "";
      order.forEach((q, i)=>{
        const b = document.createElement("button");
        b.className = "h-8 w-8 rounded-full border border-brand-accent text-xs hover:bg-brand-accent/60 transition";
        b.textContent = i+1;
        b.addEventListener("click", ()=>{ idx = i; renderQuestion(); updateMetrics(); });
        s.appendChild(b);
      });
      highlightStepper();
    }
    function highlightStepper(){
      const buttons = $$("#stepper button");
      buttons.forEach((b,i)=>{
        const q = order[i];
        const has = q.type==="choice" ? Number.isInteger(answers[q.id]) : (answers[q.id]||"").toString().trim().length>0;
        b.classList.toggle("bg-brand-blue", i===idx);
        b.classList.toggle("text-white", i===idx);
        b.classList.toggle("bg-brand-accent/80", has && i!==idx);
      });
    }

    function renderQuestion(){
      const q = order[idx];
      const wrap = $("#qViewport");
      wrap.innerHTML = "";

      const card = document.createElement("div");
      card.className = "p-5 rounded-2xl border border-brand-accent bg-white/75 fade-in";
      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs font-semibold text-brand-blue mb-1">${t("quiz.qLabel")} ${idx+1} / ${order.length}</div>
            <div class="font-medium mb-2">${q.prompt}</div>
          </div>
          <div id="badge" class="text-xs font-semibold px-2 py-0.5 rounded-full border border-transparent"></div>
        </div>
        <div class="mt-2" id="input"></div>
        <details class="mt-3">
          <summary class="text-xs cursor-pointer select-none text-brand-blueDark/80">${t("quiz.tip")}</summary>
          <div class="text-xs text-brand-blueDark/75 mt-2">${q.guidance[lang]}</div>
        </details>
        <div id="fb" class="mt-3 text-sm hidden"></div>
      `;
      wrap.appendChild(card);

      const mount = $("#input");
      if (q.type === "choice"){
        (q.options||[]).forEach((opt, i)=>{
          const lbl = document.createElement("label");
          lbl.className = "flex items-start gap-2 p-3 rounded-xl border border-brand-accent cursor-pointer hover:bg-brand-accent/50 mt-2";
          lbl.innerHTML = `<input type="radio" name="q-${q.id}" class="mt-1" /> <span>${opt.text}</span>`;
          lbl.querySelector("input").checked = answers[q.id]===i;
          lbl.querySelector("input").addEventListener("change", ()=>{
            answers[q.id] = i; showChoiceFeedback(q,i); updateMetrics();
          });
          mount.appendChild(lbl);
        });
      } else {
        const row = document.createElement("div");
        row.className = "flex gap-2 items-start";
        const ta = document.createElement("textarea");
        ta.placeholder = t("practice.placeholder");
        ta.className = "w-full min-h-[80px] p-3 rounded-xl border border-brand-accent focus-ring";
        ta.value = (answers[q.id]||"");
        const btn = document.createElement("button");
        btn.textContent = t("quiz.verifyBtn");
        btn.className = "shrink-0 h-10 px-4 rounded-xl bg-brand-blue text-white";
        btn.addEventListener("click", ()=> verifyShort(q, ta.value));
        ta.addEventListener("input", ()=>{
          answers[q.id] = ta.value;
          setBadge(ta.value.trim() ? t("quiz.badge.neutral") : "", "neutral");
          updateMetrics();
        });
        ta.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); btn.click(); }});
        row.appendChild(ta); row.appendChild(btn);
        mount.appendChild(row);

        // botón modelo
        const show = document.createElement("button");
        show.textContent = t("quiz.showModel");
        show.className = "mt-2 text-xs underline";
        show.addEventListener("click", ()=>{
          const model = q.expected?.[0] || "";
          const fb = $("#fb"); fb.classList.remove("hidden"); fb.classList.add("text-brand-blueDark"); fb.innerHTML = `<span class="font-medium">Model:</span> ${escapeHtml(model)}`;
        });
        mount.appendChild(show);
      }
      // estado previo
      if (q.type==="choice" && Number.isInteger(answers[q.id])) showChoiceFeedback(q, answers[q.id], true);
      if (q.type==="short" && (answers[q.id]||"").toString().trim()) setBadge(t("quiz.badge.neutral"), "neutral");

      // botones prev/next
      $("#prevBtn").disabled = idx===0;
      $("#nextBtn").disabled = idx===order.length-1;
      highlightStepper();
    }

    function setBadge(text, type){
      const el = $("#badge"); if (!el) return;
      el.textContent = text || "";
      el.classList.toggle("hidden", !text);
      el.classList.toggle("text-brand-blue", type==="neutral");
      el.classList.toggle("text-green-700", type==="ok");
      el.classList.toggle("text-red-700", type==="bad");
      el.classList.toggle("border", true);
      el.classList.toggle("border-brand-accent", type==="neutral");
    }

    function showChoiceFeedback(q, i, silent){
      const chosen = (q.options||[])[i];
      const ok = !!chosen?.correct;
      const fb = $("#fb");
      const explain = (I18N[lang].quiz.choice[q.id] || I18N.en.quiz.choice[q.id] || [])[i] || "";
      const recommend = (q.options||[]).find(o=>o.correct)?.text || "";
      fb.classList.remove("hidden");
      fb.classList.toggle("text-green-700", ok);
      fb.classList.toggle("text-red-700", !ok);
      fb.innerHTML = `${escapeHtml(explain)}${ok?"":` <span class="block mt-1"><span class="font-medium">${t("quiz.recommend")}:</span> ${escapeHtml(recommend)}</span>`}`;
      setBadge(ok ? t("quiz.badge.ok") : t("quiz.badge.bad"), ok?"ok":"bad");
      if (!silent) updateMetrics();
    }

    function verifyShort(q, val){
      const fb = $("#fb");
      const ok = (q.expected||[]).some(e => normalize(e) === normalize(val));
      const best = (q.expected && q.expected[0]) || "";
      fb.classList.remove("hidden");
      fb.classList.toggle("text-green-700", ok);
      fb.classList.toggle("text-red-700", !ok);
      fb.innerHTML = ok ? t("quiz.shortOk")
                        : `${t("quiz.shortBad")} <span class="block mt-1"><span class="font-medium">${t("quiz.recommend")}:</span> ${escapeHtml(best)}</span>`;
      setBadge(ok ? t("quiz.badge.ok") : t("quiz.badge.bad"), ok?"ok":"bad");
      updateMetrics();
    }

    function updateMetrics(){
      const total = order.length || 1;
      const answered = order.filter(q => q.type==="choice" ? Number.isInteger(answers[q.id]) : (answers[q.id]||"").toString().trim().length>0).length;
      const pct = Math.round((answered/total)*100);
      $("#progressText").textContent = pct + "%";
      const dash = 100 - pct; $("#ringBar").setAttribute("stroke-dashoffset", dash);
      $("#liveScore").textContent = answered ? `${t("practice.completed")}: ${answered}/${total}` : "";
      $("#submitBtn").disabled = answered===0;
    }

    function grade(){
      const details = order.map(q=>{
        if (q.type==="choice"){
          const pick = answers[q.id];
          const chosen = (q.options||[])[pick];
          const ok = !!(chosen && chosen.correct);
          const explainArr = I18N[lang].quiz.choice[q.id] || I18N.en.quiz.choice[q.id] || [];
          const why = Number.isInteger(pick) ? (explainArr[pick] || "") : t("quiz.noOption");
          const right = (q.options||[]).find(o=>o.correct)?.text || "";
          const base = ok ? (lang==='ru'?'Верно. ':'Corect. ') : (lang==='ru'?'Проверить снова. ':'De revizuit. ');
          return { id:q.id, user: chosen ? chosen.text : "-", correct: ok, feedback: base + why + (ok?"":` ${t("quiz.recommend")}: ${right}`), expected: right };
        } else {
          const userText = (answers[q.id]||"").trim();
          const ok = (q.expected||[]).some(e => normalize(e) === normalize(userText));
          const best = (q.expected && q.expected[0]) || "";
          return { id:q.id, user: userText || "-", correct: ok, feedback: ok ? t("quiz.shortOk") : `${t("quiz.shortBad")} ${t("quiz.recommend")}: „${best}”.`, expected: best };
        }
      });
      const score = details.filter(d=>d.correct).length;
      return { when: fmtNow(lang==='ru'?'ru-RU':(lang==='en'?'en-GB':'ro-RO')), score, total: order.length, details };
    }

    /* ===== RESULTS & HISTORY ===== */
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function renderResults(result){
      $("#results").classList.remove("hidden");
      const pct = Math.round((result.score / result.total)*100);
      const badge = $("#scoreBadge");
      badge.textContent = pct + "%";
      badge.classList.toggle("text-brand-blue", pct>=70);
      badge.classList.toggle("text-red-700", pct<70);

      const grid = $("#breakdown"); grid.innerHTML = "";
      result.details.forEach((d,i)=>{
        const item = document.createElement("div");
        item.className = "p-4 rounded-2xl border border-brand-accent bg-white/75";
        item.innerHTML = `
          <div class="text-xs font-semibold text-brand-blue mb-1">${t("quiz.qLabel")} ${i+1}</div>
          <div class="text-sm"><span class="font-medium">${lang==='en'?'Your answer':(lang==='ru'?'Ваш ответ':'Răspunsul tău')}:</span> ${escapeHtml(d.user)}</div>
          <div class="text-sm"><span class="font-medium">Model:</span> ${escapeHtml(d.expected||"")}</div>
          <div class="mt-2 text-sm ${d.correct?'text-green-700':'text-red-700'}">${escapeHtml(d.feedback)}</div>
        `;
        grid.appendChild(item);
      });
    }
    function getHistory(){ try { return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); } catch { return []; } }
    function saveResult(result, name){
      const arr = getHistory();
      arr.unshift({ name, when: result.when, score: result.score, total: result.total, lang });
      localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0,50)));
    }
    function renderHistory(){
      const list = $("#historyList");
      const empty = $("#emptyHistory");
      const items = getHistory();
      list.innerHTML = "";
      if (!items.length){ empty.classList.remove("hidden"); return; }
      empty.classList.add("hidden");
      items.forEach(r=>{
        const row = document.createElement("div");
        row.className = "p-4 rounded-2xl border border-brand-accent bg-white/75 flex items-center justify-between";
        row.innerHTML = `
          <div>
            <div class="font-medium">${t("history.attempt")}: <span class="text-brand-blue">${escapeHtml(r.name || (lang==='en'?'Student':'Elev/ă'))}</span></div>
            <div class="text-sm text-brand-blueDark/70">${t("history.date")}: ${escapeHtml(r.when)}</div>
          </div>
          <div class="text-sm font-semibold text-brand-blue">${r.score}/${r.total}</div>
        `;
        list.appendChild(row);
      });
    }

    /* ===== MISC ===== */
    function resetAll(){
      started = false; answers = {}; idx=0; order=[];
      $("#qViewport").innerHTML = ""; $("#results").classList.add("hidden");
      $("#liveScore").textContent = ""; $("#progressText").textContent = "0%";
      $("#ringBar").setAttribute("stroke-dashoffset", 100);
      $("#stepper").innerHTML = "";
    }

    /* ===== EVENTS ===== */
    window.addEventListener("DOMContentLoaded", ()=>{
      $("#year").textContent = new Date().getFullYear();
      initNav(); setView("home");

      // idioma
      const sel = $("#lang");
      sel.addEventListener("change", ()=>{ lang = sel.value; applyI18N(); });
      sel.value = "ro"; lang = "ro"; applyI18N();

      // focus mode
      $("#focusMode").addEventListener("change", (e)=>{
        const on = e.target.checked;
        document.body.classList.toggle("pt-2", on);
        $("#appHeader").classList.toggle("hidden", on);
      });

      // start
      $("#startBtn").addEventListener("click", ()=>{
        const name = $("#studentName").value.trim();
        const msg = { ro:"Te rugăm să introduci numele.", ru:"Введите имя, пожалуйста.", en:"Please enter your name." }[lang];
        if (!name){ alert(msg); return; }
        started = true; startQuiz();
      });

      // submit
      $("#submitBtn").addEventListener("click", ()=>{
        if (!started) return;
        const result = grade();
        renderResults(result);
        saveResult(result, $("#studentName").value.trim() || (lang==='en'?'Student':'Elev/ă'));
        renderHistory();
      });

      // nav prev/next + hotkeys
      $("#prevBtn").addEventListener("click", ()=>{ if (idx>0){ idx--; renderQuestion(); }});
      $("#nextBtn").addEventListener("click", ()=>{ if (idx<order.length-1){ idx++; renderQuestion(); }});
      document.addEventListener("keydown", (e)=>{
        if (!started) return;
        if (e.key === "ArrowLeft") { e.preventDefault(); $("#prevBtn").click(); }
        if (e.key === "ArrowRight"){ e.preventDefault(); $("#nextBtn").click(); }
        if (e.key === "Enter")     { 
          const btn = $("#qViewport button.sh-verify") || $("#qViewport button"); 
          // verifică / next heuristic
        }
      });
    });

    // helper for verify button search (not strictly needed, kept for clarity)
    // no-op; we bind directly to created elements.

  </script>
</body>
</html>
